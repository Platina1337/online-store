{% extends "blog/base.html" %}
{% load static %}
{% block css %}
	<link rel="stylesheet" href="{% static 'blog/main.css' %}">
{% endblock %}
{% block content %}
<nav class="navbar navbar-expand-lg navbar-light">
		<div class="container-fluid">
			<a class="navbar-brand" href="{% url 'main:index' %}">Stroev-Home</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav me-auto mb-2 mb-lg-0 top-menu">
					<li class="nav-item">
						<a class="nav-link" href="{% url 'main:index' %}">Home</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#Catalog">Catalog</a>
					</li>
					<li class="nav-item" >
						<a class="nav-link" href="#News">News</a>
					</li>
				</ul>
				<ul class="navbar-nav ms-auto mb-2 mb-lg-0">
					<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#"><i class="far fa-user"></i></a>
						<ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            {% if user.is_authenticated %}
                                {% if user.is_superuser %}
                                    <!-- Суперпользователь -->
                                    <li>
                                        <a class="dropdown-item" href="{% url 'admin:login' %}">
                                            <img src="{{ user.profile.image.url }}" alt="{{ user.username }}" class="avatar">
                                            {{ user.username }}
                                        </a>
                                    </li>
                                {% else %}
                                    <!-- Обычный пользователь -->
                                    <li>
                                        <a class="dropdown-item" href="#">
                                            <img src="{{ user.profile.image.url }}" alt="{{ user.username }}" class="avatar">
                                            {{ user.username }}
                                        </a>
                                    </li>
                                {% endif %}
                                <!-- Кнопка выхода -->
                                <li><a class="dropdown-item" href="{% url 'main:logout' %}">Выйти</a></li>
                            {% else %}
                                <!-- Незарегистрированный пользователь -->
                                <li><a class="dropdown-item" href="{% url 'main:login' %}">Авторизация</a></li>
                                <li><a class="dropdown-item" href="{% url 'main:register' %}">Регистрация</a></li>
                            {% endif %}
                        </ul>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="{% url 'main:home' %}" data-bs-toggle="modal" data-bs-target="#modal-cart">
							<i class="fas fa-shopping-cart"></i>
						</a>
						<div class="modal fade" id="modal-cart" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <!-- Заголовок модального окна -->
                                    <div class="modal-header bg-secondary text-white">
                                        <h5 class="modal-title" id="exampleModalLabel">Корзина</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <!-- Тело модального окна (содержимое корзины) -->
                                    <div class="modal-body">
                                        <!-- Таблица для отображения товаров в корзине -->
                                        <table class="table">
                                            <thead>
                                            </thead>
                                            <tbody id="cart-table-body">
                                                <!-- Содержимое корзины будет добавляться сюда динамически -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- Нижняя часть модального окна (футер) -->
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                                        <button type="button" class="btn btn-primary">Оформить заказ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#"><i class="fas fa-search"></i></a>
					</li>
				</ul>
			</div>
		</div>
	</nav>
<div class="container">
   <div class="row">
      <div class="col-lg-8">
         <div class="product-card">
            <div class="row">
               <div class="col-md-4">
                  <div class="product-thumb">
                     <img src="{{ product.image.url }}" alt="{{ product.title }}">
                  </div>
               </div>
               <div class="col-md-8">
                  <div class="product-details">
                     <h2>{{ product.title }}</h2>
                     <p>{{ product.description }}</p>
                     <p class="price">${{ product.price }}</p>
                     <div class="author-info">
                        <!-- Отображение аватарки автора -->
                        <img src="{{ product.author.image.url }}" alt="{{ product.author.user.username }}" class="avatar">
                        <!-- Отображение имени автора -->
                        <span>Author: {{ product.author.user.username }}</span>
                     </div>
                     <!-- Форма для добавления продукта в корзину -->
                     <form id="cart-form" action="{% url 'cart:cart_add' product.id %}" method="post">
                        {% csrf_token %}
                        {{ cart_product_form }}
                        <button type="submit" class="btn btn-dark">
                           <i class="fas fa-shopping-cart"></i> Добавить в корзину
                        </button>
                     </form>
                      <script>
                        document.getElementById('cart-form').addEventListener('submit', function(event) {
                            event.preventDefault(); // Предотвращаем стандартное поведение отправки формы

                            // Получаем данные формы
                            const formData = new FormData(this);
                            const productId = this.getAttribute('data-product-id');

                            // Отправляем AJAX-запрос на добавление товара в корзину
                            fetch(`/cart/add/${productId}/`, {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                // Обновляем содержимое корзины на странице
                                const cartContent = document.getElementById('cart-content');
                                if (cartContent) {
                                    cartContent.innerHTML = data.cart_html; // Обновляем содержимое корзины
                                }
                            })
                            .catch(error => {
                                console.error('Ошибка при добавлении товара в корзину:', error);
                            });
                        });
                    </script>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="col-lg-4">
         <!-- Блок с формой добавления отзыва -->
         {% if user.is_authenticated %}
         <div class="mt-4">
            <h3>Add a Review</h3>
            <form method="post" action="{% url 'main:post-detail' product.id product.slug %}">
               {% csrf_token %}
               {{ review_form.as_p }}
               <button type="submit" class="btn btn-dark">
                  Submit Review
               </button>
            </form>
         </div>
         {% endif %}
         <!-- Блок с отображением существующих отзывов -->
         <div class="mt-4">
            <h3>Reviews</h3>
            {% if reviews %}
                <ul class="list-unstyled">
                    {% for review in reviews %}
                        <li>
                            <img src="{{ review.author.profile.image.url }}" alt="{{ review.author.username }}" class="avatar">
                            <strong>{{ review.author.username }}</strong> - {{ review.created_at|date:"F d, Y" }}
                            <p>{{ review.content }}</p>
                        </li>
                    {% endfor %}
                </ul>
                {% if reviews.has_other_pages %}
                    <div class="pagination">
                        {% if reviews.has_previous %}
                            <a href="?page=1">&laquo; First</a>
                            <a href="?page={{ reviews.previous_page_number }}">Previous</a>
                        {% endif %}
                        <span class="current">Page {{ reviews.number }} of {{ reviews.paginator.num_pages }}</span>
                        {% if reviews.has_next %}
                            <a href="?page={{ reviews.next_page_number }}">Next</a>
                            <a href="?page={{ reviews.paginator.num_pages }}">Last &raquo;</a>
                        {% endif %}
                    </div>
                {% endif %}
            {% else %}
                <p>No reviews yet.</p>
            {% endif %}
        </div>
      </div>
   </div>
</div>

{% endblock content %}
{% block footer %}
    <footer>
        <div class="footer-content">
            <h3>Контакты</h3>
            <p>Телефон: +79206945165</p>
            <p>Email: bbd3372005@gmail.com</p>
            <p>Адрес: улица Трехсвятская д.14</p>
        </div>
        <div class="footer-content">
            <h3>Ссылки</h3>
            <ul>
                <li><a href="{% url 'main:index' %}">Главная</a></li>
                <li><a href="#">О нас</a></li>
                <li><a href="#">Контакты</a></li>
                <li><a href="#">Услуги</a></li>
            </ul>
        </div>
    </footer>
{% endblock %}